<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Rel√¢mpago HNK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00A94F 0%, #008C3E 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #00A94F;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 18px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        label .required {
            color: #00A94F;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00A94F;
            box-shadow: 0 0 0 3px rgba(0, 169, 79, 0.1);
        }

        input::placeholder {
            color: #aaa;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00A94F 0%, #008C3E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 169, 79, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: #00A94F;
            border: 2px solid #00A94F;
            margin-top: 15px;
        }

        .btn-secondary:hover {
            background: #f0fdf4;
        }

        .link-section {
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .link-btn {
            color: #00A94F;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .link-btn:hover {
            color: #008C3E;
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question-number {
            color: #00A94F;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .option {
            background: #f8f8f8;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option:hover {
            background: #f0fdf4;
            border-color: #00A94F;
        }

        .option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #00A94F;
            cursor: pointer;
        }

        .option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: 400;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00A94F 0%, #00C853 100%);
            transition: width 0.3s ease;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ranking-table th {
            background: #00A94F;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .ranking-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ranking-table tr:hover {
            background: #f8f8f8;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            color: white;
        }

        .rank-1 { background: #FFD700; }
        .rank-2 { background: #C0C0C0; }
        .rank-3 { background: #CD7F32; }
        .rank-other { background: #00A94F; }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .admin-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .admin-tab.active {
            color: #00A94F;
            border-bottom-color: #00A94F;
        }

        .admin-tab:hover {
            color: #00A94F;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .question-item {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #00A94F;
        }

        .question-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .question-item p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            display: inline-block;
            margin-right: 10px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        .result-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .result-score {
            font-size: 72px;
            font-weight: bold;
            color: #00A94F;
            margin: 20px 0;
        }

        .result-message {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00A94F;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .cda-filter {
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .logo {
                font-size: 24px;
            }

            .subtitle {
                font-size: 16px;
            }

            .admin-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela inicial do Quiz -->
        <div id="quizStartScreen">
            <div class="header">
                <div class="logo">‚ö° Quiz Rel√¢mpago HNK</div>
                <div class="subtitle" id="quizSubtitle">Carregando...</div>
            </div>

            <form id="quizStartForm">
                <div class="form-group">
                    <label>Nome Completo <span class="required">*</span></label>
                    <input type="text" id="fullName" placeholder="Digite seu nome completo" required>
                </div>

                <div class="form-group">
                    <label>Matr√≠cula Heineken <span class="required">*</span></label>
                    <input type="text" id="employeeId" placeholder="Digite sua matr√≠cula" required>
                </div>

                <div class="form-group">
                    <label>Selecione seu CDA <span class="required">*</span></label>
                    <select id="cdaSelect" required>
                        <option value="">Escolha seu CDA</option>
                    </select>
                </div>

                <button type="submit" class="btn">Iniciar Quiz</button>
            </form>

            <div class="link-section">
                <a href="#" class="link-btn" onclick="showRanking(); return false;">
                    üèÜ Ver Ranking Geral
                </a>
            </div>

            <div class="link-section">
                <a href="#" class="link-btn" onclick="showAdminLogin(); return false;">
                    üîí √Årea do Administrador
                </a>
            </div>
        </div>

        <!-- Tela do Quiz -->
        <div id="quizScreen" class="hidden">
            <div class="header">
                <div class="logo">‚ö° Quiz Rel√¢mpago HNK</div>
                <div class="subtitle" id="quizScreenSubtitle"></div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <form id="quizForm">
                <div id="questionsContainer"></div>
                <button type="submit" class="btn">Enviar Respostas</button>
            </form>
        </div>

        <!-- Tela de Resultado -->
        <div id="resultScreen" class="hidden">
            <div class="result-screen">
                <div class="header">
                    <div class="logo">‚ö° Quiz Rel√¢mpago HNK</div>
                </div>

                <div class="result-message">Sua Pontua√ß√£o</div>
                <div class="result-score" id="finalScore">0</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correctAnswers">0</div>
                        <div class="stat-label">Respostas Corretas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="timeMultiplier">0x</div>
                        <div class="stat-label">Multiplicador de Tempo</div>
                    </div>
                </div>

                <button class="btn" onclick="showRanking()">Ver Ranking</button>
                <button class="btn btn-secondary" onclick="location.reload()">P√°gina Inicial</button>
            </div>
        </div>

        <!-- Tela de Ranking -->
        <div id="rankingScreen" class="hidden">
            <div class="header">
                <div class="logo">üèÜ Ranking Geral</div>
            </div>

            <div class="cda-filter">
                <label>Filtrar por CDA:</label>
                <select id="cdaFilter" onchange="filterRanking()">
                    <option value="">Todos os CDAs</option>
                </select>
            </div>

            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Nome</th>
                        <th>Pontua√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <!-- Rankings ser√£o inseridos aqui -->
                </tbody>
            </table>

            <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 20px;">Voltar</button>
        </div>

        <!-- Login Admin -->
        <div id="adminLoginScreen" class="hidden">
            <div class="header">
                <div class="logo">üîí √Årea do Administrador</div>
            </div>

            <form id="adminLoginForm">
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="adminPassword" placeholder="Digite a senha" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
                <button type="button" class="btn btn-secondary" onclick="location.reload()">Voltar</button>
            </form>
        </div>

        <!-- Painel Admin -->
        <div id="adminPanel" class="hidden">
            <div class="header">
                <div class="logo">‚öôÔ∏è Painel Administrativo</div>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('dashboard')">Dashboard</button>
                <button class="admin-tab" onclick="switchAdminTab('questions')">Perguntas</button>
                <button class="admin-tab" onclick="switchAdminTab('responses')">Respostas</button>
                <button class="admin-tab" onclick="switchAdminTab('themes')">Temas</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <h3>Vis√£o Geral</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalResponses">0</div>
                        <div class="stat-label">Total de Respostas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgScore">0</div>
                        <div class="stat-label">M√©dia de Pontua√ß√£o</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalQuestions">0</div>
                        <div class="stat-label">Total de Perguntas</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>Desempenho por CDA</h4>
                    <div id="cdaChart"></div>
                </div>

                <button class="btn btn-secondary" onclick="logout()">Sair</button>
            </div>

            <!-- Perguntas Tab -->
            <div id="questionsTab" class="tab-content">
                <h3>Gerenciar Perguntas</h3>
                
                <div class="export-buttons">
                    <button class="btn btn-small" onclick="exportQuestions()">üì• Exportar Perguntas</button>
                    <button class="btn btn-small" onclick="showAddQuestionForm()">‚ûï Adicionar Pergunta</button>
                </div>

                <div id="addQuestionForm" class="hidden">
                    <form id="questionForm">
                        <div class="form-group">
                            <label>Tema</label>
                            <select id="questionTheme" required>
                                <option value="cerveja_retornavel">Como vender Cerveja Retorn√°vel</option>
                                <option value="margem_ganho">Como argumentar margem de ganho</option>
                                <option value="execucao_pdv">Execu√ß√£o de ponto de venda perfeita</option>
                                <option value="argumentacoes">Argumenta√ß√µes sobre produtos</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Pergunta</label>
                            <input type="text" id="questionText" placeholder="Digite a pergunta" required>
                        </div>

                        <div class="form-group">
                            <label>Op√ß√£o A</label>
                            <input type="text" id="optionA" placeholder="Digite a op√ß√£o A" required>
                        </div>

                        <div class="form-group">
                            <label>Op√ß√£o B</label>
                            <input type="text" id="optionB" placeholder="Digite a op√ß√£o B" required>
                        </div>

                        <div class="form-group">
                            <label>Op√ß√£o C</label>
                            <input type="text" id="optionC" placeholder="Digite a op√ß√£o C" required>
                        </div>

                        <div class="form-group">
                            <label>Op√ß√£o D</label>
                            <input type="text" id="optionD" placeholder="Digite a op√ß√£o D" required>
                        </div>

                        <div class="form-group">
                            <label>Resposta Correta</label>
                            <select id="correctAnswer" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>

                        <button type="submit" class="btn">Salvar Pergunta</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddQuestionForm()">Cancelar</button>
                    </form>
                </div>

                <div id="questionsList"></div>
            </div>

            <!-- Respostas Tab -->
            <div id="responsesTab" class="tab-content">
                <h3>Respostas dos Vendedores</h3>
                
                <button class="btn btn-small" onclick="exportResponses()">üì• Exportar para Excel</button>

                <table class="ranking-table" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Matr√≠cula</th>
                            <th>Nome</th>
                            <th>CDA</th>
                            <th>Tema</th>
                            <th>Nota</th>
                            <th>Tempo</th>
                            <th>Hor√°rio</th>
                        </tr>
                    </thead>
                    <tbody id="responsesBody">
                        <!-- Respostas ser√£o inseridas aqui -->
                    </tbody>
                </table>
            </div>

            <!-- Temas Tab -->
            <div id="themesTab" class="tab-content">
                <h3>Gerenciar Temas e Datas</h3>

                <div class="form-group">
                    <label>Tema Atual</label>
                    <select id="currentTheme" onchange="updateCurrentTheme()">
                        <option value="cerveja_retornavel">Como vender Cerveja Retorn√°vel</option>
                        <option value="margem_ganho">Como argumentar margem de ganho</option>
                        <option value="execucao_pdv">Execu√ß√£o de ponto de venda perfeita</option>
                        <option value="argumentacoes">Argumenta√ß√µes sobre produtos</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data de Envio do Quiz</label>
                    <input type="datetime-local" id="quizSendTime" onchange="updateQuizSendTime()">
                </div>

                <h4 style="margin-top: 30px;">Agendar Mudan√ßa de Tema</h4>
                
                <form id="scheduleThemeForm">
                    <div class="form-group">
                        <label>Data da Mudan√ßa</label>
                        <input type="date" id="themeChangeDate" required>
                    </div>

                    <div class="form-group">
                        <label>Novo Tema</label>
                        <select id="newTheme" required>
                            <option value="cerveja_retornavel">Como vender Cerveja Retorn√°vel</option>
                            <option value="margem_ganho">Como argumentar margem de ganho</option>
                            <option value="execucao_pdv">Execu√ß√£o de ponto de venda perfeita</option>
                            <option value="argumentacoes">Argumenta√ß√µes sobre produtos</option>
                        </select>
                    </div>

                    <button type="submit" class="btn">Agendar Mudan√ßa</button>
                </form>

                <div id="scheduledThemes" style="margin-top: 30px;">
                    <h4>Mudan√ßas Agendadas</h4>
                    <div id="scheduledThemesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sistema de armazenamento usando localStorage como fallback
        const Storage = {
            async get(key) {
                // Tentar usar window.storage primeiro (Claude.ai)
                if (typeof window.storage !== 'undefined') {
                    try {
                        const result = await window.storage.get(key);
                        return result ? JSON.parse(result.value) : null;
                    } catch (error) {
                        console.log('Key not found in window.storage:', key);
                        return null;
                    }
                } else {
                    // Fallback para localStorage (uso fora do Claude.ai)
                    try {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : null;
                    } catch (error) {
                        console.log('Key not found in localStorage:', key);
                        return null;
                    }
                }
            },

            async set(key, value) {
                // Tentar usar window.storage primeiro (Claude.ai)
                if (typeof window.storage !== 'undefined') {
                    try {
                        const result = await window.storage.set(key, JSON.stringify(value));
                        return result !== null;
                    } catch (error) {
                        console.error('Storage error:', error);
                        return false;
                    }
                } else {
                    // Fallback para localStorage (uso fora do Claude.ai)
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (error) {
                        console.error('localStorage error:', error);
                        return false;
                    }
                }
            },

            async delete(key) {
                // Tentar usar window.storage primeiro (Claude.ai)
                if (typeof window.storage !== 'undefined') {
                    try {
                        await window.storage.delete(key);
                        return true;
                    } catch (error) {
                        console.error('Delete error:', error);
                        return false;
                    }
                } else {
                    // Fallback para localStorage (uso fora do Claude.ai)
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        console.error('localStorage delete error:', error);
                        return false;
                    }
                }
            },

            async list(prefix) {
                // Tentar usar window.storage primeiro (Claude.ai)
                if (typeof window.storage !== 'undefined') {
                    try {
                        const result = await window.storage.list(prefix);
                        return result ? result.keys : [];
                    } catch (error) {
                        console.error('List error:', error);
                        return [];
                    }
                } else {
                    // Fallback para localStorage (uso fora do Claude.ai)
                    try {
                        const keys = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith(prefix)) {
                                keys.push(key);
                            }
                        }
                        return keys;
                    } catch (error) {
                        console.error('localStorage list error:', error);
                        return [];
                    }
                }
            }
        };

        // Dados iniciais
        const CDAs = [
            'CDA S√£o Paulo - Centro', 'CDA S√£o Paulo - Zona Norte', 'CDA S√£o Paulo - Zona Sul',
            'CDA Rio de Janeiro - Centro', 'CDA Rio de Janeiro - Zona Oeste',
            'CDA Belo Horizonte', 'CDA Bras√≠lia', 'CDA Curitiba', 'CDA Porto Alegre',
            'CDA Salvador', 'CDA Recife', 'CDA Fortaleza', 'CDA Manaus', 'CDA Bel√©m',
            'CDA Goi√¢nia', 'CDA Campinas', 'CDA Santos', 'CDA Ribeir√£o Preto',
            'CDA S√£o Jos√© dos Campos', 'CDA Sorocaba', 'CDA Guarulhos', 'CDA Osasco',
            'CDA Vit√≥ria', 'CDA Florian√≥polis', 'CDA Joinville', 'CDA Londrina',
            'CDA Maring√°', 'CDA Uberl√¢ndia', 'CDA Juiz de Fora', 'CDA Natal'
        ];

        const themeNames = {
            'cerveja_retornavel': 'Como vender Cerveja Retorn√°vel',
            'margem_ganho': 'Como argumentar margem de ganho dos nossos produtos',
            'execucao_pdv': 'Como fazer uma execu√ß√£o de ponto de venda perfeita',
            'argumentacoes': 'Argumenta√ß√µes sobre nossos produtos'
        };

        // Perguntas exemplo
        const defaultQuestions = {
            'cerveja_retornavel': [
                {
                    id: 'q1',
                    text: 'Qual √© a principal vantagem da cerveja retorn√°vel para o cliente?',
                    options: ['Menor pre√ßo', 'Embalagem bonita', 'Maior quantidade', 'Mais sabor'],
                    correct: 'A'
                },
                {
                    id: 'q2',
                    text: 'Como calcular o custo-benef√≠cio da cerveja retorn√°vel?',
                    options: ['Pre√ßo dividido por litro', 'Pre√ßo total', 'Peso da garrafa', 'Cor da embalagem'],
                    correct: 'A'
                }
            ],
            'margem_ganho': [
                {
                    id: 'q3',
                    text: 'Qual argumento √© mais eficaz para demonstrar margem de ganho?',
                    options: ['Mostrar c√°lculo de lucro l√≠quido', 'Falar do pre√ßo', 'Mencionar concorrentes', 'Falar da marca'],
                    correct: 'A'
                }
            ],
            'execucao_pdv': [
                {
                    id: 'q4',
                    text: 'O que √© essencial em uma execu√ß√£o perfeita de PDV?',
                    options: ['Visibilidade do produto', 'Pre√ßo baixo', 'Muitas marcas', 'Pouca organiza√ß√£o'],
                    correct: 'A'
                }
            ],
            'argumentacoes': [
                {
                    id: 'q5',
                    text: 'Qual o principal diferencial da Heineken?',
                    options: ['Qualidade premium', 'Pre√ßo baixo', 'Garrafa grande', 'Cor verde'],
                    correct: 'A'
}
]
};
// Estado da aplica√ß√£o
    let currentUser = null;
    let currentQuestions = [];
    let userAnswers = [];
    let quizStartTime = null;

    // Inicializa√ß√£o
    async function init() {
        await initializeDefaultData();
        populateCDASelects();
        await loadCurrentTheme();
        checkScheduledThemes();
    }

    async function initializeDefaultData() {
        // Inicializar perguntas padr√£o se n√£o existirem
        for (const [theme, questions] of Object.entries(defaultQuestions)) {
            const existingQuestions = await Storage.get(`questions:${theme}`);
            if (!existingQuestions || existingQuestions.length === 0) {
                const success = await Storage.set(`questions:${theme}`, questions);
                console.log(`Initialized ${theme} with ${questions.length} questions:`, success);
            }
        }

        // Inicializar configura√ß√µes
        const config = await Storage.get('quiz-config');
        if (!config) {
            const success = await Storage.set('quiz-config', {
                currentTheme: 'cerveja_retornavel',
                quizSendTime: null,
                scheduledThemes: []
            });
            console.log('Initialized config:', success);
        }
    }

    function populateCDASelects() {
        const cdaSelect = document.getElementById('cdaSelect');
        const cdaFilter = document.getElementById('cdaFilter');

        CDAs.forEach(cda => {
            const option1 = document.createElement('option');
            option1.value = cda;
            option1.textContent = cda;
            cdaSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = cda;
            option2.textContent = cda;
            cdaFilter.appendChild(option2);
        });
    }

    async function loadCurrentTheme() {
        const config = await Storage.get('quiz-config');
        const currentTheme = config?.currentTheme || 'cerveja_retornavel';
        const themeName = themeNames[currentTheme];
        
        document.getElementById('quizSubtitle').textContent = themeName;
        document.getElementById('quizScreenSubtitle').textContent = themeName;
        
        if (document.getElementById('currentTheme')) {
            document.getElementById('currentTheme').value = currentTheme;
        }
    }

    async function checkScheduledThemes() {
        const config = await Storage.get('quiz-config');
        if (!config || !config.scheduledThemes) return;

        const today = new Date().toISOString().split('T')[0];
        let updated = false;

        for (const scheduled of config.scheduledThemes) {
            if (scheduled.date === today && scheduled.theme !== config.currentTheme) {
                config.currentTheme = scheduled.theme;
                updated = true;
            }
        }

        // Remover temas j√° aplicados
        config.scheduledThemes = config.scheduledThemes.filter(s => s.date > today);

        if (updated) {
            await Storage.set('quiz-config', config);
            await loadCurrentTheme();
        }
    }

    // Quiz Start
    document.getElementById('quizStartForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fullName = document.getElementById('fullName').value.trim();
        const employeeId = document.getElementById('employeeId').value.trim();
        const cda = document.getElementById('cdaSelect').value;

        // Verificar se j√° respondeu
        const existingResponse = await Storage.get(`response:${employeeId}`);
        if (existingResponse) {
            alert('Voc√™ j√° respondeu este quiz!');
            return;
        }

        currentUser = { fullName, employeeId, cda };
        
        await loadQuizQuestions();
        showScreen('quizScreen');
    });

    async function loadQuizQuestions() {
        const config = await Storage.get('quiz-config');
        const currentTheme = config?.currentTheme || 'cerveja_retornavel';
        
        const allQuestions = await Storage.get(`questions:${currentTheme}`) || [];
        
        // Selecionar 5-6 perguntas aleat√≥rias
        const numQuestions = Math.min(6, allQuestions.length);
        currentQuestions = shuffleArray(allQuestions).slice(0, numQuestions);
        
        renderQuestions();
        quizStartTime = Date.now();
        
        // Salvar hor√°rio de envio se n√£o existir
        if (!config.quizSendTime) {
            config.quizSendTime = new Date().toISOString();
            await Storage.set('quiz-config', config);
        }
    }

    function renderQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        currentQuestions.forEach((question, index) => {
            const options = shuffleArray([
                { label: 'A', text: question.options[0] },
                { label: 'B', text: question.options[1] },
                { label: 'C', text: question.options[2] },
                { label: 'D', text: question.options[3] }
            ]);

            const questionHtml = `
                <div class="question-container">
                    <div class="question-number">Pergunta ${index + 1} de ${currentQuestions.length}</div>
                    <div class="question-text">${question.text}</div>
                    ${options.map((opt, i) => `
                        <div class="option">
                            <input type="radio" name="q${index}" value="${opt.label}" id="q${index}_${i}" required>
                            <label for="q${index}_${i}">${opt.text}</label>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML += questionHtml;
        });

        updateProgressBar();
    }

    function updateProgressBar() {
        const answered = document.querySelectorAll('input[type="radio"]:checked').length;
        const total = currentQuestions.length;
        const progress = (answered / total) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    document.addEventListener('change', (e) => {
        if (e.target.type === 'radio') {
            updateProgressBar();
        }
    });

    // Submit Quiz
    document.getElementById('quizForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        userAnswers = [];
        let correctCount = 0;

        currentQuestions.forEach((question, index) => {
            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
            const userAnswer = selectedOption ? selectedOption.value : null;
            
            userAnswers.push({
                questionId: question.id,
                userAnswer: userAnswer,
                correctAnswer: question.correct,
                isCorrect: userAnswer === question.correct
            });

            if (userAnswer === question.correct) {
                correctCount++;
            }
        });

        await calculateAndSaveScore(correctCount);
    });

    async function calculateAndSaveScore(correctCount) {
        const config = await Storage.get('quiz-config');
        const quizSendTime = config?.quizSendTime ? new Date(config.quizSendTime) : new Date();
        const responseTime = new Date();
        
        // Calcular multiplicador baseado no hor√°rio
        const hoursSinceQuizSent = (responseTime - quizSendTime) / (1000 * 60 * 60);
        
        let multiplier = 1.0;
        if (hoursSinceQuizSent < 1) {
            multiplier = 1.4;
        } else if (hoursSinceQuizSent < 2) {
            multiplier = 1.3;
        } else if (hoursSinceQuizSent < 3) {
            multiplier = 1.2;
        } else if (hoursSinceQuizSent < 4) {
            multiplier = 1.1;
        } else if (hoursSinceQuizSent >= 24) {
            multiplier = 0; // N√£o pontua ap√≥s 24h
        }

        const baseScore = (correctCount / currentQuestions.length) * 100;
        const finalScore = Math.round(baseScore * multiplier);

        // Salvar resposta
        const response = {
            employeeId: currentUser.employeeId,
            fullName: currentUser.fullName,
            cda: currentUser.cda,
            theme: config?.currentTheme || 'cerveja_retornavel',
            score: finalScore,
            correctAnswers: correctCount,
            totalQuestions: currentQuestions.length,
            multiplier: multiplier,
            responseTime: responseTime.toISOString(),
            timeTaken: Math.round((Date.now() - quizStartTime) / 1000), // segundos
            answers: userAnswers
        };

        await Storage.set(`response:${currentUser.employeeId}`, response);

        // Mostrar resultado
        showResult(finalScore, correctCount, multiplier);
    }

    function showResult(score, correct, multiplier) {
        document.getElementById('finalScore').textContent = score;
        document.getElementById('correctAnswers').textContent = `${correct}/${currentQuestions.length}`;
        document.getElementById('timeMultiplier').textContent = multiplier.toFixed(1) + 'x';
        
        showScreen('resultScreen');
    }

    // Ranking
    async function showRanking() {
        const keys = await Storage.list('response:');
        const responses = [];

        for (const key of keys) {
            const response = await Storage.get(key);
            if (response) {
                responses.push(response);
            }
        }

        // Ordenar por pontua√ß√£o
        responses.sort((a, b) => b.score - a.score);

        renderRanking(responses);
        showScreen('rankingScreen');
    }

    function renderRanking(responses, filteredCDA = null) {
        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = '';

        let filteredResponses = responses;
        if (filteredCDA) {
            filteredResponses = responses.filter(r => r.cda === filteredCDA);
        }

        filteredResponses.forEach((response, index) => {
            const rank = index + 1;
            let rankClass = 'rank-other';
            if (rank === 1) rankClass = 'rank-1';
            else if (rank === 2) rankClass = 'rank-2';
            else if (rank === 3) rankClass = 'rank-3';

            const row = `
                <tr>
                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td>${response.fullName}</td>
                    <td>${response.score}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function filterRanking() {
        const selectedCDA = document.getElementById('cdaFilter').value;
        const keys = await Storage.list('response:');
        const responses = [];

        for (const key of keys) {
            const response = await Storage.get(key);
            if (response) {
                responses.push(response);
            }
        }

        responses.sort((a, b) => b.score - a.score);
        renderRanking(responses, selectedCDA || null);
    }

    // Admin
    function showAdminLogin() {
        showScreen('adminLoginScreen');
    }

    document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const password = document.getElementById('adminPassword').value;
        if (password === 'Capabilities04') {
            showScreen('adminPanel');
            loadAdminDashboard();
        } else {
            alert('Senha incorreta!');
        }
    });

    async function loadAdminDashboard() {
        await updateDashboardStats();
        await loadQuestionsList();
        await loadResponsesList();
        await loadThemesSettings();
    }

    async function updateDashboardStats() {
        const keys = await Storage.list('response:');
        const responses = [];

        for (const key of keys) {
            const response = await Storage.get(key);
            if (response) {
                responses.push(response);
            }
        }

        document.getElementById('totalResponses').textContent = responses.length;
        
        const avgScore = responses.length > 0 
            ? Math.round(responses.reduce((sum, r) => sum + r.score, 0) / responses.length)
            : 0;
        document.getElementById('avgScore').textContent = avgScore;

        // Contar total de perguntas
        let totalQuestions = 0;
        for (const theme of Object.keys(themeNames)) {
            const questions = await Storage.get(`questions:${theme}`);
            if (questions) {
                totalQuestions += questions.length;
            }
        }
        document.getElementById('totalQuestions').textContent = totalQuestions;

        // Gr√°fico de desempenho por CDA
        renderCDAChart(responses);
    }

    function renderCDAChart(responses) {
        const cdaScores = {};
        
        responses.forEach(r => {
            if (!cdaScores[r.cda]) {
                cdaScores[r.cda] = { total: 0, count: 0 };
            }
            cdaScores[r.cda].total += r.score;
            cdaScores[r.cda].count++;
        });

        const chartContainer = document.getElementById('cdaChart');
        chartContainer.innerHTML = '';

        Object.entries(cdaScores).forEach(([cda, data]) => {
            const avg = Math.round(data.total / data.count);
            const barWidth = (avg / 100) * 100; // Porcentagem
            
            const bar = `
                <div style="margin: 10px 0;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${cda}</div>
                    <div style="background: #e0e0e0; border-radius: 4px; height: 24px; position: relative;">
                        <div style="background: linear-gradient(90deg, #00A94F 0%, #00C853 100%); 
                                    width: ${barWidth}%; height: 100%; border-radius: 4px; 
                                    display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
                            <span style="color: white; font-weight: bold; font-size: 12px;">${avg}</span>
                        </div>
                    </div>
                </div>
            `;
            chartContainer.innerHTML += bar;
        });
    }

    // Questions Management
    async function loadQuestionsList() {
        const container = document.getElementById('questionsList');
        container.innerHTML = '<h4 style="margin: 20px 0;">Perguntas por Tema</h4>';

        for (const [themeKey, themeName] of Object.entries(themeNames)) {
            const questions = await Storage.get(`questions:${themeKey}`) || [];
            
            container.innerHTML += `<h5 style="color: #00A94F; margin-top: 20px;">${themeName} (${questions.length})</h5>`;
            
            if (questions.length === 0) {
                container.innerHTML += `<p style="color: #666; margin: 10px 0;">Nenhuma pergunta cadastrada</p>`;
            } else {
                questions.forEach((q, index) => {
                    const questionItem = `
                        <div class="question-item">
                            <h4>${index + 1}. ${q.text}</h4>
                            <p><strong>A:</strong> ${q.options[0]}</p>
                            <p><strong>B:</strong> ${q.options[1]}</p>
                            <p><strong>C:</strong> ${q.options[2]}</p>
                            <p><strong>D:</strong> ${q.options[3]}</p>
                            <p><strong>Resposta correta:</strong> ${q.correct}</p>
                            <button class="btn btn-small" onclick="deleteQuestion('${themeKey}', '${q.id}')" 
                                    style="background: #dc3545;">üóëÔ∏è Deletar</button>
                        </div>
                    `;
                    container.innerHTML += questionItem;
                });
            }
        }
    }

    function showAddQuestionForm() {
        document.getElementById('addQuestionForm').classList.remove('hidden');
    }

    function hideAddQuestionForm() {
        document.getElementById('addQuestionForm').classList.add('hidden');
        document.getElementById('questionForm').reset();
    }

    document.getElementById('questionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const theme = document.getElementById('questionTheme').value;
        const questionText = document.getElementById('questionText').value;
        const optionA = document.getElementById('optionA').value;
        const optionB = document.getElementById('optionB').value;
        const optionC = document.getElementById('optionC').value;
        const optionD = document.getElementById('optionD').value;
        const correct = document.getElementById('correctAnswer').value;

        const newQuestion = {
            id: 'q' + Date.now(),
            text: questionText,
            options: [optionA, optionB, optionC, optionD],
            correct: correct
        };

        console.log('Saving question to theme:', theme);
        console.log('New question:', newQuestion);

        const questions = await Storage.get(`questions:${theme}`) || [];
        console.log('Existing questions:', questions);
        
        questions.push(newQuestion);
        console.log('Updated questions:', questions);
        
        const saved = await Storage.set(`questions:${theme}`, questions);
        console.log('Save result:', saved);

        if (saved) {
            hideAddQuestionForm();
            await loadQuestionsList();
            await updateDashboardStats();
            alert('Pergunta adicionada com sucesso!');
        } else {
            alert('Erro ao salvar pergunta. Tente novamente.');
        }
    });

    async function deleteQuestion(theme, questionId) {
        if (!confirm('Tem certeza que deseja deletar esta pergunta?')) return;

        const questions = await Storage.get(`questions:${theme}`) || [];
        const filtered = questions.filter(q => q.id !== questionId);
        await Storage.set(`questions:${theme}`, filtered);

        await loadQuestionsList();
        await updateDashboardStats();
        alert('Pergunta deletada com sucesso!');
    }

    async function exportQuestions() {
        let csvContent = 'Tema,Pergunta,Op√ß√£o A,Op√ß√£o B,Op√ß√£o C,Op√ß√£o D,Resposta Correta\n';

        for (const [themeKey, themeName] of Object.entries(themeNames)) {
            const questions = await Storage.get(`questions:${themeKey}`) || [];
            
            questions.forEach(q => {
                csvContent += `"${themeName}","${q.text}","${q.options[0]}","${q.options[1]}","${q.options[2]}","${q.options[3]}","${q.correct}"\n`;
            });
        }

        downloadCSV(csvContent, 'perguntas_quiz.csv');
    }

    // Responses Management
    async function loadResponsesList() {
        const keys = await Storage.list('response:');
        const responses = [];

        for (const key of keys) {
            const response = await Storage.get(key);
            if (response) {
                responses.push(response);
            }
        }

        responses.sort((a, b) => new Date(b.responseTime) - new Date(a.responseTime));

        const tbody = document.getElementById('responsesBody');
        tbody.innerHTML = '';

        responses.forEach(r => {
            const responseDate = new Date(r.responseTime);
            const formattedDate = responseDate.toLocaleString('pt-BR');
            const formattedTime = Math.floor(r.timeTaken / 60) + 'min ' + (r.timeTaken % 60) + 's';

            const row = `
                <tr>
                    <td>${r.employeeId}</td>
                    <td>${r.fullName}</td>
                    <td>${r.cda}</td>
                    <td>${themeNames[r.theme]}</td>
                    <td>${r.score}</td>
                    <td>${formattedTime}</td>
                    <td>${formattedDate}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function exportResponses() {
        const keys = await Storage.list('response:');
        const responses = [];

        for (const key of keys) {
            const response = await Storage.get(key);
            if (response) {
                responses.push(response);
            }
        }

        let csvContent = 'Matr√≠cula,Nome,CDA,Tema,Nota,Acertos,Total Perguntas,Multiplicador,Tempo (segundos),Hor√°rio\n';

        responses.forEach(r => {
            const responseDate = new Date(r.responseTime).toLocaleString('pt-BR');
            csvContent += `"${r.employeeId}","${r.fullName}","${r.cda}","${themeNames[r.theme]}",${r.score},${r.correctAnswers},${r.totalQuestions},${r.multiplier},${r.timeTaken},"${responseDate}"\n`;
        });

        downloadCSV(csvContent, 'respostas_quiz.csv');
    }

    // Themes Management
    async function loadThemesSettings() {
        const config = await Storage.get('quiz-config');
        
        if (config) {
            document.getElementById('currentTheme').value = config.currentTheme;
            
            if (config.quizSendTime) {
                const date = new Date(config.quizSendTime);
                const formatted = date.toISOString().slice(0, 16);
                document.getElementById('quizSendTime').value = formatted;
            }

            renderScheduledThemes(config.scheduledThemes || []);
        }
    }

    async function updateCurrentTheme() {
        const newTheme = document.getElementById('currentTheme').value;
        const config = await Storage.get('quiz-config') || {
            currentTheme: 'cerveja_retornavel',
            quizSendTime: null,
            scheduledThemes: []
        };
        
        config.currentTheme = newTheme;
        const saved = await Storage.set('quiz-config', config);
        
        console.log('Theme updated:', newTheme, 'Saved:', saved);
        
        if (saved) {
            await loadCurrentTheme();
            alert('Tema atualizado com sucesso!');
        } else {
            alert('Erro ao atualizar tema!');
        }
    }

    async function updateQuizSendTime() {
        const newTime = document.getElementById('quizSendTime').value;
        const config = await Storage.get('quiz-config') || {
            currentTheme: 'cerveja_retornavel',
            quizSendTime: null,
            scheduledThemes: []
        };
        
        config.quizSendTime = new Date(newTime).toISOString();
        const saved = await Storage.set('quiz-config', config);
        
        console.log('Send time updated:', newTime, 'Saved:', saved);
        
        if (saved) {
            alert('Hor√°rio de envio atualizado!');
        } else {
            alert('Erro ao atualizar hor√°rio!');
        }
    }

    document.getElementById('scheduleThemeForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const date = document.getElementById('themeChangeDate').value;
        const theme = document.getElementById('newTheme').value;

        const config = await Storage.get('quiz-config') || {
            currentTheme: 'cerveja_retornavel',
            quizSendTime: null,
            scheduledThemes: []
        };
        
        if (!config.scheduledThemes) {
            config.scheduledThemes = [];
        }

        config.scheduledThemes.push({ date, theme });
        config.scheduledThemes.sort((a, b) => a.date.localeCompare(b.date));

        const saved = await Storage.set('quiz-config', config);
        
        console.log('Theme scheduled:', date, theme, 'Saved:', saved);
        
        if (saved) {
            document.getElementById('scheduleThemeForm').reset();
            renderScheduledThemes(config.scheduledThemes);
            alert('Mudan√ßa de tema agendada!');
        } else {
            alert('Erro ao agendar mudan√ßa de tema!');
        }
    });

    function renderScheduledThemes(scheduled) {
        const container = document.getElementById('scheduledThemesList');
        container.innerHTML = '';

        if (scheduled.length === 0) {
            container.innerHTML = '<p style="color: #666;">Nenhuma mudan√ßa agendada</p>';
            return;
        }

        scheduled.forEach((s, index) => {
            const date = new Date(s.date).toLocaleDateString('pt-BR');
            const item = `
                <div class="question-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4>${date}</h4>
                        <p>${themeNames[s.theme]}</p>
                    </div>
                    <button class="btn btn-small" onclick="removeScheduledTheme(${index})" 
                            style="background: #dc3545;">Remover</button>
                </div>
            `;
            container.innerHTML += item;
        });
    }

    async function removeScheduledTheme(index) {
        const config = await Storage.get('quiz-config');
        config.scheduledThemes.splice(index, 1);
        await Storage.set('quiz-config', config);
        renderScheduledThemes(config.scheduledThemes);
    }

    // Utility Functions
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function showScreen(screenId) {
        const screens = ['quizStartScreen', 'quizScreen', 'resultScreen', 'rankingScreen', 'adminLoginScreen', 'adminPanel'];
        screens.forEach(screen => {
            document.getElementById(screen).classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    }

    function switchAdminTab(tabName) {
        const tabs = document.querySelectorAll('.admin-tab');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function logout() {
        location.reload();
    }

    // Inicializar quando a p√°gina carregar
    window.addEventListener('load', init);
 </script>
</body>
</html>